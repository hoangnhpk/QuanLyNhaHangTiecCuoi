@model IEnumerable<QuanLyNhaHang.Models.KhachHang>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Quản lý khách hàng";
}

<div class="message-container">
    @{
        // Hiển thị thông báo thành công (Success)
        if (TempData["SuccessMessage"] != null)
        {
            <div class="alert success-alert">
                <strong>Thành công!</strong> @TempData["SuccessMessage"]
                <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
            </div>
        }

        // Hiển thị thông báo lỗi (Danger/Error)
        if (TempData["ErrorMessage"] != null)
        {
            <div class="alert danger-alert">
                <strong>Lỗi!</strong> @TempData["ErrorMessage"]
                <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
            </div>
        }
    }
</div>

<div class="crud-container">
    <h1>Quản Lý Khách Hàng</h1>

    <!-- Nút Thêm mới -->
    <div class="action-buttons">
        <a asp-action="Create" class="btn-create-new">
            <i class="fas fa-plus"></i> Thêm khách hàng mới
        </a>
    </div>

    <div class="tab-header">
        <button class="tab-button active" onclick="openTab(event, 'CustomerInfo')">Thông tin khách hàng</button>
        <button class="tab-button" onclick="openTab(event, 'AccountLogin')">Tài khoản đăng nhập</button>
    </div>

    <div id="CustomerInfo" class="tab-content active">
        @if (Model != null && Model.Any())
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã KH</th>
                        <th>Tên Khách Hàng</th>
                        <th>CCCD</th>
                        <th>Số Điện Thoại</th>
                        <th>Địa Chỉ</th>
                        <th>Email</th>
                        <th>Trạng Thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.MaKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.TenKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.CccdKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.SdtKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.DiaChiKhachHang)</td>
                            <td>
                                @if (item.TaiKhoan != null)
                                {
                                    @Html.DisplayFor(modelItem => item.TaiKhoan.Email)
                                }
                                else
                                {
                                    <span class="text-muted">(Chưa có)</span>
                                }
                            </td>
                            <td>
                                @{
                                    string status = item.TrangThaiKhachHang;
                                    string statusClass = status == "Hoạt động" ? "active" : "inactive";
                                    string statusText = status == "Hoạt động" ? "Hoạt động" :
                                    status == "Khóa" ? "Khóa" : status;
                                }
                                <span class="status-badge status-@statusClass">@statusText</span>
                            </td>
                            <td class="action-buttons-cell">
                                <a asp-action="Edit" asp-route-id="@item.MaKhachHang" class="btn-action btn-edit">
                                    <i class="fas fa-edit"></i> Sửa
                                </a>
                                <a asp-action="Details" asp-route-id="@item.MaKhachHang" class="btn-action btn-details">
                                    <i class="fas fa-info-circle"></i> Chi tiết
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert info-alert empty-data-msg">
                <i class="fas fa-info-circle"></i> <strong>Thông báo!</strong> Hiện tại không có dữ liệu khách hàng nào trong hệ thống.
            </div>
        }
    </div>

    <div id="AccountLogin" class="tab-content">
        @if (Model != null && Model.Any(kh => kh.TaiKhoan != null))
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã KH</th>
                        <th>Tên KH</th>
                        <th>Tài Khoản</th>
                        <th>Mật Khẩu</th>
                        <th>Email</th>
                        <th>Vai Trò</th>
                        <th>Trạng Thái TK</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Where(kh => kh.TaiKhoan != null))
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.MaKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.TenKhachHang)</td>
                            <td>@Html.DisplayFor(modelItem => item.TaiKhoan.UserName)</td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.TaiKhoan.Password))
                                {
                                    <span class="password-masked">••••••••</span>
                                }
                                else
                                {
                                    <span class="text-muted">(Chưa đặt)</span>
                                }
                            </td>
                            <td>@Html.DisplayFor(modelItem => item.TaiKhoan.Email)</td>
                            <td>@Html.DisplayFor(modelItem => item.TaiKhoan.VaiTro)</td>
                            <td>
                                @{
                                    string tkStatus = item.TaiKhoan.TrangThai;
                                    string tkStatusClass = tkStatus == "Hoạt động" ? "active" :
                                    tkStatus == "Khóa" ? "inactive" : "unknown";
                                    string tkStatusText = tkStatus == "Hoạt động" ? "Hoạt động" :
                                    tkStatus == "Khóa" ? "Khóa" : tkStatus;
                                }
                                <span class="status-badge status-@tkStatusClass">@tkStatusText</span>
                            </td>
                            <td class="action-buttons-cell">
                                <a asp-action="Details" asp-route-id="@item.MaKhachHang" class="btn-action btn-details">
                                    <i class="fas fa-info-circle"></i> Chi tiết
                                </a>
                                @if (item.TaiKhoan.TrangThai == "Hoạt động")
                                {
                                    <form asp-action="Lock" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@item.MaKhachHang" />
                                        <button type="submit" class="btn-action btn-lock"
                                                onclick="return confirm('Bạn có chắc muốn KHÓA tài khoản của @item.TenKhachHang?')">
                                            <i class="fas fa-lock"></i> Khóa
                                        </button>
                                    </form>
                                }
                                else if (item.TaiKhoan.TrangThai == "Khóa")
                                {
                                    <form asp-action="Unlock" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@item.MaKhachHang" />
                                        <button type="submit" class="btn-action btn-unlock"
                                                onclick="return confirm('Bạn có chắc muốn MỞ KHÓA tài khoản của @item.TenKhachHang?')">
                                            <i class="fas fa-unlock"></i> Mở khóa
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert info-alert empty-data-msg">
                <i class="fas fa-info-circle"></i> <strong>Thông báo!</strong> Hiện tại không có tài khoản đăng nhập nào được gán cho khách hàng.
            </div>
        }
    </div>
</div>

<style>
    :root {
        --primary: #cda45e;
        --primary-soft: rgba(205, 164, 94, 0.12);
        --bg-elevated: #15120f;
        --text-main: #f4f4f4;
        --text-muted: #a6a6a6;
        --danger: #ff5c5c;
        --success: #4caf50;
        --warning: #ff9800;
        --info: #5bc0de;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --radius-md: 10px;
        --radius-pill: 999px;
    }

    /* Container chính */
    .crud-container {
        max-width: 100%;
        margin: 0;
        padding: 20px 30px;
        background-color: var(--bg-elevated);
        color: var(--text-main);
        border-radius: var(--radius-md);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
        font-family: "Poppins", system-ui, sans-serif;
        border: 1px solid var(--border-subtle);
    }

        .crud-container h1 {
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--primary);
            border-bottom: 2px solid var(--primary-soft);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

    /* Nút thêm mới */
    .action-buttons {
        margin-bottom: 20px;
    }

    .btn-create-new {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        color: var(--primary);
        background: rgba(205, 164, 94, 0.1);
        border: 1px solid rgba(205, 164, 94, 0.3);
        transition: all 0.2s ease;
    }

        .btn-create-new:hover {
            background: rgba(205, 164, 94, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(205, 164, 94, 0.2);
        }

        .btn-create-new i {
            font-size: 12px;
        }

    /* Tabs */
    .tab-header {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .tab-button {
        background: none;
        border: none;
        padding: 10px 20px;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
        font-weight: 500;
    }

        .tab-button:hover:not(.active) {
            color: var(--text-main);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }

    /* Tab content */
    .tab-content {
        display: none;
    }

        .tab-content.active {
            display: block;
        }

    /* Table */
    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 10px;
    }

        .table thead {
            background: rgba(255, 255, 255, 0.03);
        }

        .table th, .table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            vertical-align: middle;
        }

        .table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.08em;
            white-space: nowrap;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

    /* Status badges */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: var(--radius-pill);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 80px;
        text-align: center;
    }

    .status-active {
        color: var(--success);
        background: rgba(76, 175, 80, 0.15);
        border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .status-inactive {
        color: var(--danger);
        background: rgba(255, 92, 92, 0.15);
        border: 1px solid rgba(255, 92, 92, 0.3);
    }

    .status-unknown {
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Action buttons */
    .action-buttons-cell {
        white-space: nowrap;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-size: 12px;
        font-weight: 500;
        text-decoration: none;
        border: 1px solid transparent;
        transition: all 0.2s ease;
        margin-right: 5px;
        cursor: pointer;
    }

        .btn-action:last-child {
            margin-right: 0;
        }

        .btn-action i {
            font-size: 11px;
        }

    .btn-edit {
        color: var(--primary);
        background: rgba(205, 164, 94, 0.1);
        border-color: rgba(205, 164, 94, 0.3);
    }

        .btn-edit:hover {
            background: rgba(205, 164, 94, 0.2);
        }

    .btn-details {
        color: var(--info);
        background: rgba(91, 192, 222, 0.1);
        border-color: rgba(91, 192, 222, 0.3);
    }

        .btn-details:hover {
            background: rgba(91, 192, 222, 0.2);
        }

    .btn-lock {
        color: var(--danger);
        background: rgba(255, 92, 92, 0.1);
        border-color: rgba(255, 92, 92, 0.3);
    }

        .btn-lock:hover {
            background: rgba(255, 92, 92, 0.2);
        }

    .btn-unlock {
        color: var(--success);
        background: rgba(76, 175, 80, 0.1);
        border-color: rgba(76, 175, 80, 0.3);
    }

        .btn-unlock:hover {
            background: rgba(76, 175, 80, 0.2);
        }

    /* Form buttons inside cells */
    .d-inline {
        display: inline-block;
    }

        .d-inline button {
            border: none;
            background: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
        }

    /* Password masked */
    .password-masked {
        letter-spacing: 2px;
        font-weight: 600;
    }

    /* Alerts */
    .message-container {
        padding: 0 30px;
        margin-bottom: 20px;
        max-width: 100%;
    }

    .alert {
        position: relative;
        padding: 12px 15px;
        margin-bottom: 15px;
        border-radius: var(--radius-md);
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .success-alert {
        color: var(--success);
        background: rgba(76, 175, 80, 0.15);
        border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .danger-alert {
        color: var(--danger);
        background: rgba(255, 92, 92, 0.15);
        border: 1px solid rgba(255, 92, 92, 0.3);
    }

    .info-alert {
        color: var(--info);
        background: rgba(91, 192, 222, 0.15);
        border: 1px solid rgba(91, 192, 222, 0.3);
    }

    .empty-data-msg {
        text-align: center;
        padding: 20px;
        margin-top: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .close-btn {
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        line-height: 1;
        cursor: pointer;
        padding: 0 5px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

        .close-btn:hover {
            opacity: 1;
        }

    .text-muted {
        color: var(--text-muted) !important;
        font-style: italic;
    }
    /* Thay thế phần CSS cho các nút action */
    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        margin-right: 8px;
        cursor: pointer;
        min-width: 90px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
    }

        .btn-action:last-child {
            margin-right: 0;
        }

        .btn-action i {
            font-size: 11px;
            transition: transform 0.3s ease;
        }

        .btn-action:hover i {
            transform: translateY(-1px);
        }

        /* Hiệu ứng hover chung cho tất cả nút */
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

    /* Nút Edit - Màu vàng sáng */
    .btn-edit {
        color: #000 !important;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        border-color: #ffd700;
    }

        .btn-edit:hover {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
        }

    /* Nút Details - Màu xanh dương */
    .btn-details {
        color: #fff !important;
        background: linear-gradient(135deg, #3498db, #2980b9);
        border-color: #3498db;
    }

        .btn-details:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }

    /* Nút Lock - Màu đỏ cam nổi bật */
    .btn-lock {
        color: #fff !important;
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        border-color: #ff6b6b;
        position: relative;
        padding-left: 40px;
    }

        .btn-lock:before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.3s ease;
        }

        .btn-lock:hover:before {
            transform: translateY(-50%) rotate(15deg);
        }

        .btn-lock:hover {
            background: linear-gradient(135deg, #ee5a52, #ff6b6b);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4);
        }

    /* Nút Unlock - Màu xanh lá sáng */
    .btn-unlock {
        color: #000 !important;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        border-color: #2ecc71;
        position: relative;
        padding-left: 40px;
    }

        .btn-unlock:before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='black'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            transition: transform 0.3s ease;
        }

        .btn-unlock:hover:before {
            transform: translateY(-50%) rotate(-15deg);
        }

        .btn-unlock:hover {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4);
        }

    /* Form buttons inside cells */
    .d-inline {
        display: inline-block;
    }

        .d-inline button {
            border: none;
            background: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font: inherit;
        }

    /* Hiệu ứng ripple cho nút */
    .btn-action::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }

    .btn-action:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    },

    {
        transform: scale(0, 0);
        opacity: 0.5;
    }

    100% {
        transform: scale(20, 20);
        opacity: 0;
    }

    }

    /* Hiệu ứng loading khi click */
    .btn-action.loading {
        pointer-events: none;
        opacity: 0.7;
    }

        .btn-action.loading i {
            animation: spin 1s linear infinite;
        },

    .btn-action {
        width: 100%;
        margin-right: 0;
        justify-content: flex-start;
        padding-left: 16px;
    }

    .btn-lock,
    .btn-unlock {
        padding-left: 40px;
    }

    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Tab switching logic
            window.openTab = function (evt, tabName) {
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Remove active class from all tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Show current tab and activate button
                document.getElementById(tabName).classList.add('active');
                evt.currentTarget.classList.add('active');
            }

            // Auto-hide alerts after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.display = 'none';
                });
            }, 5000);
        });
    </script>
}