@model IEnumerable<QuanLyNhaHang.Models.KhachHang>


@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Index";
}


<div class="message-container">
    @{
        // Hiển thị thông báo thành công (Success)
        if (TempData["SuccessMessage"] != null)
        {
            <div class="alert success-alert">
                <strong>Thành công!</strong> @TempData["SuccessMessage"]
                <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
            </div>
        }

        // Hiển thị thông báo lỗi (Danger/Error)
        if (TempData["ErrorMessage"] != null)
        {
            <div class="alert danger-alert">
                <strong>Lỗi!</strong> @TempData["ErrorMessage"]
                <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
            </div>
        }
    }
</div>


<div class="crud-container">
    <h1>Quản Lý Khách Hàng</h1>


    <div class="tab-header">
        <button class="tab-button active" onclick="openTab(event, 'CustomerInfo')">Thông tin khách hàng</button>
        <button class="tab-button" onclick="openTab(event, 'AccountLogin')">Tài khoản đăng nhập</button>
    </div>

    <div id="CustomerInfo" class="tab-content active">
        @if (Model != null && Model.Any())
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã KH</th>
                        <th>Tên Khách Hàng</th>
                        <th>CCCD</th>
                        <th>Số Điện Thoại</th>
                        <th>Địa Chỉ</th>
                        <th>Email</th>
                        <th>Trạng Thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.MaKhachHang)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.TenKhachHang)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.CccdKhachHang)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.SdtKhachHang)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DiaChiKhachHang)
                            </td>
                            <td>
                                @if (item.TaiKhoan != null)
                                {
                                    @Html.DisplayFor(modelItem => item.TaiKhoan.Email)
                                }
                                else
                                {
                                    <span>(Không có TK)</span>
                                }
                            </td>
                            <td>
                                @{
                                    string statusValue = item.TrangThaiKhachHang;
                                    string vietnameseStatus;
                                    string cssStatusClass;

                                    if (statusValue == "Active" || statusValue == "HOẠT ĐỘNG")
                                    {
                                        vietnameseStatus = "Hoạt động";
                                        cssStatusClass = "active";
                                    }
                                    else if (statusValue == "Inactive" || statusValue == "NGỪNG HOẠT ĐỘNG")
                                    {
                                        vietnameseStatus = "Khóa";
                                        cssStatusClass = "inactive";
                                    }
                                    else
                                    {
                                        vietnameseStatus = statusValue;
                                        cssStatusClass = "unknown";
                                    }

                                    <span class="status-badge status-@cssStatusClass">@vietnameseStatus</span>
                                }
                            </td>
                            <td>
                                <a asp-controller="QL_KhachHang" asp-action="Edit" asp-route-id="@item.MaKhachHang" class="btn-action btn-edit">Sửa</a>
                                <a asp-controller="QL_KhachHang" asp-action="Details" asp-route-id="@item.MaKhachHang" class="btn-action btn-details">Chi Tiết</a>

                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert info-alert empty-data-msg">
                <i class="fa fa-info-circle"></i> <strong>Thông báo!</strong> Hiện tại không có dữ liệu khách hàng nào trong hệ thống.
            </div>
        }
    </div>

    <div id="AccountLogin" class="tab-content">
        @if (Model != null && Model.Any(kh => kh.TaiKhoan != null))
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã KH</th>
                        <th>Tài Khoản</th>
                        <th>Mật Khẩu</th>
                        <th>Email</th>
                        <th>Vai Trò</th>
                        <th>Trạng Thái TK</th>
                        <th>Ghi Chú</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Where(kh => kh.TaiKhoan != null))
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.MaKhachHang)
                            </td>
                            <td>
                                @if (item.TaiKhoan != null)
                                {
                                    @Html.DisplayFor(modelItem => item.TaiKhoan.UserName)
                                }
                                else
                                {
                                    <span>(Không có TK)</span>
                                }
                            </td>
                            <td>
                                @if (item.TaiKhoan != null && !string.IsNullOrEmpty(item.TaiKhoan.Password))
                                {
                                    <span>********</span>
                                }
                                else
                                {
                                    <span>(Không có)</span>
                                }
                            </td>
                            <td>
                                @if (item.TaiKhoan != null)
                                {
                                    @Html.DisplayFor(modelItem => item.TaiKhoan.Email)
                                }
                                else
                                {
                                    <span>(Không có TK)</span>
                                }
                            </td>
                            <td>
                                @if (item.TaiKhoan != null)
                                {
                                    @Html.DisplayFor(modelItem => item.TaiKhoan.VaiTro)
                                }
                                else
                                {
                                    <span>(Chưa gán)</span>
                                }
                            </td>
                            <td>
                                @{
                                    // Trạng thái này phải lấy từ trường TrangThai của TaiKhoan,
                                    // nhưng hiện tại bạn đang dùng TrangThaiKhachHang. Tôi sẽ dùng TrangThai của TaiKhoan nếu có.
                                    string tkStatusValue = item.TaiKhoan?.TrangThai ?? item.TrangThaiKhachHang;
                                    string tkVietnameseStatus;
                                    string tkCssStatusClass;

                                    if (tkStatusValue == "Active" || tkStatusValue == "HOẠT ĐỘNG")
                                    {
                                        tkVietnameseStatus = "Hoạt động";
                                        tkCssStatusClass = "active";
                                    }
                                    else if (tkStatusValue == "Inactive" || tkStatusValue == "NGỪNG HOẠT ĐỘNG")
                                    {
                                        tkVietnameseStatus = "Khóa";
                                        tkCssStatusClass = "inactive";
                                    }
                                    else
                                    {
                                        tkVietnameseStatus = tkStatusValue;
                                        tkCssStatusClass = "unknown";
                                    }

                                    <span class="status-badge status-@tkCssStatusClass">@tkVietnameseStatus</span>
                                }
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.GhiChu)
                            </td>
                            <td>
                                <a asp-controller="QL_KhachHang" asp-action="Details" asp-route-id="@item.MaKhachHang" class="btn-action btn-details">Chi Tiết</a>
                                <form asp-controller="QL_KhachHang" asp-action="Lock" asp-route-id="@item.MaKhachHang" method="post" style="display:inline;">
                                    <input type="hidden" name="id" value="@item.MaKhachHang" />
                                    <button type="submit"
                                            class="btn-action btn-lock lock-btn"
                                            data-customer-name="@item.TenKhachHang"
                                            onclick="return confirm('Bạn có chắc chắn muốn KHÓA tài khoản của khách hàng &quot;@item.TenKhachHang&quot; không?');">
                                        Khóa
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert info-alert empty-data-msg">
                <i class="fa fa-info-circle"></i> <strong>Thông báo!</strong> Hiện tại không có tài khoản đăng nhập nào được gán cho khách hàng.
            </div>
        }
    </div>
</div>

<style>
    /* BỔ SUNG BIẾN CSS CHO MÀU INFO */
    :root {
        --primary: #cda45e;
        --primary-soft: rgba(205, 164, 94, 0.12);
        --bg-elevated: #15120f;
        --text-main: #f4f4f4;
        --text-muted: #a6a6a6;
        --danger: #ff5c5c;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --success-base: #4caf50;
        --success-soft: rgba(76, 175, 80, 0.2);
        --lock-base: #ff9800;
        --lock-soft: rgba(255, 152, 0, 0.15);
        --radius-md: 10px;
        --radius-pill: 999px;
        /* Màu mới cho badge trạng thái */
        --active-color: var(--success-base);
        --inactive-color: var(--danger);
        /* BỔ SUNG MÀU INFO */
        --info-base: #5bc0de;
        --info-soft: rgba(91, 192, 222, 0.2);
    }

    /* -------------------------------------- */
    /* 🔔 STYLE CHO THÔNG BÁO (ALERT) 🔔 */
    /* -------------------------------------- */

    .message-container {
        padding: 0 30px;
        margin-bottom: 20px;
        max-width: 100%;
    }

    .alert {
        position: relative;
        padding: 10px 15px;
        margin-bottom: 10px;
        border: 1px solid transparent;
        border-radius: var(--radius-md);
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* BỔ SUNG STYLE INFO ALERT */
    .info-alert {
        color: var(--info-base);
        background-color: var(--info-soft);
        border-color: rgba(91, 192, 222, 0.5);
    }

    /* BỔ SUNG STYLE CHO DỮ LIỆU RỖNG */
    .empty-data-msg {
        text-align: center;
        padding: 20px;
        margin-top: 20px;
        font-size: 14px;
        font-weight: 500;
    }

        .empty-data-msg i {
            margin-right: 10px;
        }

    .success-alert {
        color: var(--success-base);
        background-color: var(--success-soft);
        border-color: rgba(76, 175, 80, 0.5);
    }

    .danger-alert {
        color: var(--danger);
        background-color: rgba(255, 92, 92, 0.15);
        border-color: rgba(255, 92, 92, 0.5);
    }

    .alert strong {
        font-weight: 600;
        margin-right: 5px;
    }

    /* ... (CSS còn lại giữ nguyên) ... */

    .close-btn {
        background: none;
        border: none;
        color: inherit;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        padding: 0 5px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

        .close-btn:hover {
            opacity: 1;
        }

    /* Container chính */
    .crud-container {
        max-width: 100%;
        margin: 0;
        padding: 20px 30px;
        background-color: var(--bg-elevated);
        color: var(--text-main);
        border-radius: var(--radius-md);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.7);
        font-family: "Poppins", system-ui, sans-serif;
        border: 1px solid var(--border-subtle);
    }

        .crud-container h1 {
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--primary);
            border-bottom: 2px solid var(--primary-soft);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

    /* TABLE STYLES */
    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 20px;
    }

        .table thead {
            background: rgba(255, 255, 255, 0.03);
        }

        .table th, .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .table th {
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.08em;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* ACTION BUTTONS TRONG BẢNG */
        .table td .btn-action {
            display: inline-block;
            padding: 2px 6px;
            border-radius: var(--radius-pill);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.16s ease-out;
            border: 1px solid transparent;
            white-space: nowrap;
            /* 📌 QUAN TRỌNG: ĐẶT CHIỀU RỘNG VÀ CĂN CHỮ */
            width: 65px; /* Đặt chiều rộng cố định */
            text-align: center; /* Căn chữ ra giữa nút */
        }

        /* THAY ĐỔI: Chỉnh sửa nút Sửa để có nền tối và màu chữ Vàng/Đồng */
        .table td .btn-edit {
            color: var(--primary); /* Giữ màu chữ vàng/đồng */
            background: rgba(255, 255, 255, 0.05); /* Nền xám tối/đen */
            border-color: rgba(255, 255, 255, 0.15); /* Viền xám mờ */
        }

            .table td .btn-edit:hover {
                background: rgba(255, 255, 255, 0.1);
                filter: none;
            }


        /* Giữ nguyên style gốc cho nút Chi Tiết */
        .table td .btn-details {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

            .table td .btn-details:hover {
                background: rgba(255, 255, 255, 0.1);
                filter: none;
            }
        /* KẾT THÚC THAY ĐỔI */


        /* 📌 QUAN TRỌNG: CĂN CHỈNH KHOẢNG CÁCH */
        .table td .btn-details,
        .table td .btn-lock {
            margin-left: 5px; /* Tách nút "Chi Tiết" và "Khóa" ra khỏi nút trước */
        }

    /* Đảm bảo nút đầu tiên không có margin thừa */
    #CustomerInfo .table td .btn-edit,
    #AccountLogin .table td .btn-details {
        margin-left: 0;
    }

    .table td .btn-details {
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.15);
    }

        .table td .btn-details:hover {
            background: rgba(255, 255, 255, 0.1);
        }

    /* STYLE CHO NÚT KHÓA */
    .table td .btn-lock {
        color: var(--lock-base);
        background: var(--lock-soft);
        border-color: rgba(255, 152, 0, 0.5);
    }

        .table td .btn-lock:hover {
            filter: brightness(1.2);
        }


    /* QUY TẮC CĂN CHỈNH DÍNH SÁT */
    .table td .btn-details,
    .table td .btn-lock {
        margin-left: -1px;
    }

    /* Đảm bảo nút đầu tiên trong chuỗi không bị dính sát */
    #CustomerInfo .table td .btn-edit,
    #AccountLogin .table td .btn-details {
        margin-left: 0;
    }


    /* Nút Create New */
    .btn-create-new {
        display: inline-block;
        padding: 8px 16px;
        border-radius: var(--radius-pill);
        font-size: 13px;
        font-weight: 600;
        text-decoration: none;
        color: var(--primary);
        background: rgba(205, 164, 94, 0.1);
        border: 1px solid rgba(205, 164, 94, 0.5);
        transition: all 0.16s ease-out;
        margin-bottom: 15px;
    }

        .btn-create-new:hover {
            background: rgba(205, 164, 94, 0.2);
            transform: translateY(-1px);
        }

    /* -------------------------------------- */
    /* 🎨 STYLE CHO TAB VÀ TRẠNG THÁI 🎨 */
    /* -------------------------------------- */

    /* Container cho các nút tab */
    .tab-header {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 0;
        border-bottom: 1px solid var(--border-subtle);
    }

    .tab-button {
        background: none;
        border: none;
        padding: 10px 15px;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border-bottom: 2px solid transparent;
        font-weight: 500;
    }

        .tab-button:hover:not(.active) {
            color: var(--text-main);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }

    /* Nội dung của từng tab */
    .tab-content {
        display: none;
    }

        .tab-content.active {
            display: block;
        }

    /* STYLE CHO BADGE TRẠNG THÁI */
    /* STYLE CHO BADGE TRẠNG THÁI */
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: var(--radius-pill);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        border: 1px solid transparent;
        /* THÊM 2 THUỘC TÍNH NÀY ĐỂ ĐỘ DÀI BẰNG NHAU */
        width: 100px;
        text-align: center;
    }

    .status-active {
        color: var(--active-color);
        background-color: var(--success-soft);
        border-color: rgba(76, 175, 80, 0.5);
    }

    .status-inactive {
        color: var(--inactive-color);
        background-color: rgba(255, 92, 92, 0.15);
        border-color: rgba(255, 92, 92, 0.5);
    }

    /* Thêm style cho trường hợp không xác định (nếu cần) */
    .status-unknown {
        color: var(--text-muted);
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ----------------------------------------
            // LOGIC KHÓA TÀI KHOẢN (ĐÃ SỬ DỤNG FORM POST)
            // ----------------------------------------
            // Thêm logic cho nút Khóa (Lock) nếu nó nằm trong tab AccountLogin
            document.querySelectorAll('.lock-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    const url = this.getAttribute('asp-action') + '/' + this.getAttribute('asp-route-id');
                    const customerName = this.getAttribute('data-customer-name');

                    // Giữ nguyên logic onclick inline để xác nhận
                });
            });


            // ----------------------------------------
            // LOGIC CHUYỂN TAB (GIỮ NGUYÊN)
            // ----------------------------------------
            window.openTab = function (evt, tabName) {
                let i, tabcontent, tabbuttons;

                // Ẩn tất cả nội dung tab
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].classList.remove("active");
                }

                // Loại bỏ class 'active' khỏi tất cả nút tab
                tabbuttons = document.getElementsByClassName("tab-button");
                for (i = 0; i < tabbuttons.length; i++) {
                    tabbuttons[i].classList.remove("active");
                }

                // Hiển thị tab hiện tại và kích hoạt nút bấm
                document.getElementById(tabName).classList.add("active");
                evt.currentTarget.classList.add("active");
            }
        });
    </script>
}