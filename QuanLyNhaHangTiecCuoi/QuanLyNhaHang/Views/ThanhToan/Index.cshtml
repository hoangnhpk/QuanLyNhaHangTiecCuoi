@{
    ViewData["Title"] = "Quản lý thanh toán";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    .badge-danger {
        background-color: #ff4d4d !important;
        color: white !important;
        border: 1px solid #ff3333;
    }
</style>

<div class="module-view active" id="module-payments" style="display:block;">
    <div class="module-header">
        <div>
            <div class="module-title">Quản lý thanh toán</div>
            <div class="module-desc">Theo dõi tiền cọc 30% và thanh toán hoàn tất cho từng bữa tiệc.</div>
        </div>
        <div class="toolbar">
            <input type="date" class="input" id="filterDate" style="min-width:160px;" />

            <select class="filter-select" id="filterStatus">
                <option value="Tất cả trạng thái">Tất cả trạng thái</option>
                <option value="Đã cọc 30%">Đã cọc 30%</option>
                <option value="Thanh toán hoàn toàn">Thanh toán hoàn toàn</option>
                <option value="Hủy">Hủy tiệc</option>
            </select>
        </div>
    </div>

    <div class="data-card">
        <table>
            <thead>
                <tr>
                    <th>Mã thanh toán</th>
                    <th>Mã tiệc</th>
                    <th>Mã KH</th>
                    <th>Tổng giá trị</th>
                    <th>Giá trị 30%</th>
                    <th>Trạng thái</th>
                    <th>Ngày đặt cọc</th>
                    <th>Ngày thanh toán</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="tblPaymentBody">
            </tbody>
        </table>
    </div>
</div>

<div class="modal-backdrop" id="modalPayment">
    <div class="modal">
        <div class="modal-header">
            <div>
                <div class="pill">Thanh toán</div>
                <div class="modal-title" id="modalTitleDetail">Cập nhật thanh toán</div>
            </div>
            <button class="btn-close" onclick="closePaymentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group">
                    <label>Mã thanh toán</label>
                    <input class="input" id="txtMaThanhToan" readonly />
                </div>
                <div class="form-group">
                    <label>Mã tiệc</label>
                    <input class="input" id="txtMaTiec" readonly />
                </div>
                <div class="form-group">
                    <label>Mã khách hàng</label>
                    <input class="input" id="txtMaKH" readonly />
                </div>
                <div class="form-group">
                    <label>Tổng giá trị bữa tiệc</label>
                    <input class="input" id="txtTongGiaTri" readonly />
                </div>
                <div class="form-group">
                    <label>Giá trị 30%</label>
                    <input class="input" id="txtTienCoc" readonly />
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select class="select" id="selTrangThai" onchange="toggleCancelReason()">
                        <option value="Đã cọc 30%">Đã cọc 30%</option>
                        <option value="Thanh toán hoàn toàn">Thanh toán hoàn toàn</option>
                        <option value="Hủy">Hủy tiệc</option>
                    </select>
                </div>

                <div class="form-group" id="divLyDoHuy" style="grid-column: span 2; display: none;">
                    <label style="color: #d33; font-weight: bold;">Lý do hủy tiệc *</label>
                    <textarea class="input" id="txtLyDoHuy" rows="2" placeholder="Nhập lý do khách hủy tiệc..."></textarea>
                </div>

                <div class="form-group" id="groupNgayCoc">
                    <label>Ngày đặt cọc</label>
                    <input type="date" class="input" id="dateNgayCoc" readonly />
                </div>
                <div class="form-group" id="groupNgayThanhToan">
                    <label>Ngày thanh toán</label>
                    <input type="date" class="input" id="dateNgayThanhToan" />
                </div>

                <div class="form-group" id="groupPhuongThuc">
                    <label>Phương thức thanh toán</label>
                    <select class="select" id="selPhuongThuc">
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                        <option value="Thẻ tín dụng">Thẻ tín dụng</option>
                    </select>
                </div>

                <div class="form-group" style="grid-column: span 2" id="groupGhiChu">
                    <label>Ghi chú</label>
                    <input class="input" id="txtGhiChu" placeholder="Ghi chú thanh toán..." />
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closePaymentModal()">Đóng</button>
            <button class="btn" id="btnSavePayment">Lưu thay đổi</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_URL = '/api/ThanhToan';
        let currentData = null;

        $(document).ready(function () {
            loadPayments();
            $('#filterStatus, #filterDate').on('change', loadPayments);
            $('#btnSavePayment').on('click', prepareConfirmModal);
        });

        function loadPayments() {
            $.ajax({
                url: API_URL,
                type: 'GET',
                data: { TrangThai: $('#filterStatus').val(), FromDate: $('#filterDate').val() },
                success: renderTable
            });
        }

        function renderTable(data) {
            const tbody = $('#tblPaymentBody').empty();
            data.forEach(item => {
                let displayStatus = item.trangThai;
                let badgeClass = 'badge-warning';

                if (item.trangThai === 'huy') {
                    displayStatus = 'Đã hủy';
                    badgeClass = 'badge-danger';
                } else if (item.isCompleted || item.trangThai === 'Completed') {
                    displayStatus = 'Thanh toán hoàn toàn';
                    badgeClass = 'badge-success';
                } else {
                    displayStatus = 'Đã cọc 30%';
                    badgeClass = 'badge-warning';
                }

                let actionBtn = (item.trangThai === 'huy' || item.isCompleted)
                    ? `<button class="btn-icon" onclick="openPaymentDetail('${item.maDatTiec}', true)">👁</button>`
                    : `<button class="btn-icon" onclick="openPaymentDetail('${item.maDatTiec}', false)">✓</button>`;

                tbody.append(`
                    <tr>
                        <td>${item.maThanhToan || '-'}</td>
                        <td>${item.maDatTiec}</td>
                        <td>${item.maKhachHang}</td>
                        <td>${new Intl.NumberFormat('vi-VN').format(item.tongGiaTri)}</td>
                        <td>${new Intl.NumberFormat('vi-VN').format(item.tienCoc)}</td>
                        <td><span class="badge ${badgeClass}">${displayStatus}</span></td>
                        <td>${formatDate(item.ngayDatCoc)}</td>
                        <td>${item.ngayThanhToan ? formatDate(item.ngayThanhToan) : '-'}</td>
                        <td><div class="table-actions">${actionBtn}</div></td>
                    </tr>
                `);
            });
        }

        function openPaymentDetail(id, isViewOnly) {
            $.ajax({
                url: `${API_URL}/Detail/${id}`,
                type: 'GET',
                success: function (data) {
                    currentData = data;
                    $('#txtMaThanhToan').val(data.maThanhToan);
                    $('#txtMaTiec').val(data.maDatTiec);
                    $('#txtMaKH').val(data.maKhachHang);
                    $('#txtTongGiaTri').val(new Intl.NumberFormat('vi-VN').format(data.tongGiaTri));
                    $('#txtTienCoc').val(new Intl.NumberFormat('vi-VN').format(data.tienCoc));

                    $('#selTrangThai').val(data.trangThai === 'huy' ? 'Hủy' : data.trangThai);

                    if(data.trangThai === 'huy') $('#txtLyDoHuy').val(data.ghiChu);
                    else $('#txtGhiChu').val(data.ghiChu);

                    $('#dateNgayCoc').val(formatInputDate(data.ngayDatCoc));
                    $('#dateNgayThanhToan').val(formatInputDate(data.ngayThanhToan || new Date()));
                    $('#selPhuongThuc').val(data.phuongThucThanhToan || 'Tiền mặt');

                    toggleCancelReason();

                    if (isViewOnly) {
                        $('.modal-body input, .modal-body select, .modal-body textarea').prop('disabled', true);
                        $('#btnSavePayment').hide();
                    } else {
                        $('.modal-body input, .modal-body select, .modal-body textarea').prop('disabled', false);
                        $('#txtMaThanhToan, #txtMaTiec, #txtMaKH, #txtTongGiaTri, #txtTienCoc, #dateNgayCoc').prop('readonly', true);
                        $('#btnSavePayment').show();
                    }
                    $('#modalPayment').addClass('active');
                }
            });
        }

        function toggleCancelReason() {
            const status = $('#selTrangThai').val();
            if (status === 'Hủy' || status === 'huy') {
                $('#divLyDoHuy').show();
                $('#groupNgayThanhToan, #groupPhuongThuc, #groupGhiChu').hide();
            } else {
                $('#divLyDoHuy').hide();
                $('#groupNgayThanhToan, #groupPhuongThuc, #groupGhiChu').show();
            }
        }

        function prepareConfirmModal() {
            const status = $('#selTrangThai').val();

            if (status === 'Hủy') {
                // KIỂM TRA RÀNG BUỘC NGÀY TRƯỚC KHI XÁC NHẬN
                if (currentData.ngayToChuc) {
                    const eventDate = new Date(currentData.ngayToChuc);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    eventDate.setHours(0,0,0,0);

                    const diffTime = eventDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 3) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Không thể hủy tiệc',
                            text: `Tiệc diễn ra vào ngày ${formatDate(currentData.ngayToChuc)}. Chỉ được hủy tiệc trước ngày tổ chức tối thiểu 3 ngày.`
                        });
                        return;
                    }
                }

                if (!$('#txtLyDoHuy').val().trim()) {
                    Swal.fire('Chú ý', 'Hãy nhập lý do hủy!', 'warning');
                    return;
                }
            }

            const modal = document.getElementById('customConfirmModal');
            document.getElementById('modalTitle').innerText = "XÁC NHẬN";
            document.getElementById('modalDesc').innerText = "Bạn có muốn lưu thay đổi này không?";
            document.getElementById('btnConfirmAction').onclick = callApiConfirm;
            modal.style.display = 'flex';
        }

        function callApiConfirm() {
            const status = $('#selTrangThai').val();
            currentData.trangThai = status;
            currentData.ghiChu = (status === 'Hủy') ? $('#txtLyDoHuy').val() : $('#txtGhiChu').val();
            currentData.ngayThanhToan = $('#dateNgayThanhToan').val();
            currentData.phuongThucThanhToan = $('#selPhuongThuc').val();

            $.ajax({
                url: `${API_URL}/Confirm`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(currentData),
                success: function () {
                    document.getElementById('customConfirmModal').style.display = 'none';
                    closePaymentModal();
                    loadPayments();
                    Swal.fire('Thành công', 'Đã cập nhật trạng thái.', 'success');
                },
                error: function (err) {
                    Swal.fire('Lỗi', err.responseText || 'Không thể lưu.', 'error');
                    document.getElementById('customConfirmModal').style.display = 'none';
                }
            });
        }

        function closePaymentModal() { $('#modalPayment').removeClass('active'); }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : ''; }
        function formatInputDate(d) { return d ? new Date(d).toISOString().split('T')[0] : ''; }
    </script>
}