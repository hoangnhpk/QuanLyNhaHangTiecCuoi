@model QuanLyNhaHang.Models.DatTiec

@{
    ViewData["Title"] = "Thống kê & Báo cáo";
    Layout = "_LayoutAdmin";
}

<style>
    :root {
        --gold: #c5a059;
        --dark: #121212;
        --panel: #1e1e1e;
        --text: #e0e0e0;
        --red: #ff5252;
        --green: #4caf50;
    }

    body {
        background-color: var(--dark);
        color: var(--text);
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
    }

    .dashboard-container {
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        background: var(--panel);
        padding: 15px 20px;
        border-radius: 8px;
        border-bottom: 2px solid var(--gold);
    }

    .page-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--gold);
        text-transform: uppercase;
    }

    .my-select, .my-date {
        background: #333;
        border: 1px solid #555;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        outline: none;
    }

    .my-date {
        color-scheme: dark;
    }

    .grid-box {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .my-card {
        background: var(--panel);
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #333;
    }

    .card-head {
        font-size: 16px;
        font-weight: bold;
        color: var(--gold);
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-area {
        height: 250px;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
    }

    .col-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        justify-content: flex-end;
        width: 100%;
    }

    .col-pair {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 100%;
    }

    .bar-col {
        width: 15px;
        min-height: 2px;
        transition: height 0.5s;
        border-radius: 2px 2px 0 0;
        position: relative;
    }

    .bg-gold {
        background: var(--gold);
        opacity: 0.8;
    }

    .bg-red {
        background: var(--red);
        opacity: 0.8;
    }

    .lbl-date {
        margin-top: 5px;
        font-size: 11px;
        color: #888;
    }

    .row-stat {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed #333;
    }

    .val-stat {
        font-weight: bold;
        color: #fff;
    }

    .table-wrap {
        overflow-x: auto;
    }

    .nice-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px;
    }

        .nice-table th {
            text-align: left;
            padding: 12px;
            color: #888;
            border-bottom: 1px solid #444;
        }

        .nice-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
        }

    .btn-xem {
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9998;
        display: none;
    }

        .backdrop.show {
            display: block;
        }

    .side-panel {
        position: fixed;
        top: 0;
        right: -700px;
        width: 600px;
        max-width: 95%;
        height: 100vh;
        background: #181818;
        z-index: 9999;
        border-left: 2px solid var(--gold);
        transition: 0.3s;
        display: flex;
        flex-direction: column;
    }

        .side-panel.open {
            right: 0;
        }

    .p-header {
        padding: 20px;
        background: #222;
        display: flex;
        justify-content: space-between;
    }

    .p-body {
        padding: 25px;
        overflow-y: auto;
        flex: 1;
    }

    .info-box {
        background: rgba(255,255,255,0.03);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #333;
        margin-bottom: 20px;
    }
</style>

<div class="dashboard-container">
    <div class="top-bar">
        <div class="page-title">Thống Kê Doanh Thu</div>
        <div class="tools-area">
            <select class="my-select" id="analyticsRange">
                <option value="day">Theo ngày</option>
                <option value="month" selected>Theo tháng</option>
                <option value="year">Theo năm</option>
            </select>
            <input type="month" id="filterDate" class="my-date" />
        </div>
    </div>

    <div class="grid-box">
        <div class="my-card">
            <div class="card-head">
                <span>Biểu đồ Đặt tiệc</span>
                <div style="font-size:12px;"><span style="color:var(--gold)">■ Tổng</span> &nbsp; <span style="color:var(--red)">■ Hủy</span></div>
            </div>
            <div class="chart-area" id="chartContainer"></div>
        </div>
        <div class="my-card">
            <div class="card-head">Tổng hợp số liệu</div>
            <div class="row-stat"><span>Tổng số tiệc</span><span class="val-stat" id="valTotal">0</span></div>
            <div class="row-stat"><span>Số đơn hủy</span><span class="val-stat" style="color:var(--red)" id="valCancel">0</span></div>
            <div class="row-stat"><div><span>Doanh thu dự kiến</span></div><span class="val-stat" style="color:var(--gold)" id="valExpected">0 ₫</span></div>
            <div class="row-stat"><div><span>Thực thu (Đã nhận)</span></div><span class="val-stat" style="color:var(--green)" id="valActual">0 ₫</span></div>
            <div class="row-stat" style="border:none;"><span>Còn lại chưa thu</span><span class="val-stat" id="valRemain">0 ₫</span></div>
        </div>
    </div>

    <div class="my-card">
        <div class="card-head">
            <span>Danh sách đơn hàng</span>
            <select class="my-select" id="tableStatusFilter" onchange="loadData()">
                <option value="Tất cả">Tất cả trạng thái</option>
                <option value="Đã cọc">Đã cọc 30%</option>
                <option value="Hoàn tất">Hoàn tất</option>
                <option value="Đã hủy">Đã hủy</option>
            </select>
        </div>
        <div class="table-wrap">
            <table class="nice-table">
                <thead>
                    <tr>
                        <th>Mã ĐT</th>
                        <th>Ngày TC</th>
                        <th>Khách hàng</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th style="text-align:center">Chi tiết</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="my-select" id="btnPrev" disabled> < </button>
            <span id="pageInfo" style="margin:0 10px; color:#888;">1/1</span>
            <button class="my-select" id="btnNext" disabled> > </button>
        </div>
    </div>
</div>

<div class="backdrop" id="backdrop" onclick="closePanel()"></div>
<div class="side-panel" id="sidePanel">
    <div class="p-header">
        <div style="color:var(--gold); font-weight:bold;">CHI TIẾT: <span id="p_Ma" style="color:#fff"></span></div>
        <button onclick="closePanel()" style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">×</button>
    </div>
    <div class="p-body">
        <div class="info-box" id="p_Info"></div>
        <div style="color:var(--gold); margin-bottom:10px; font-weight:bold;">THỰC ĐƠN / DỊCH VỤ</div>
        <div id="p_Details"></div>
    </div>
</div>

<script>
    let currentPage = 1;
    document.addEventListener("DOMContentLoaded", () => {
        const now = new Date();
        document.getElementById('filterDate').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('analyticsRange').addEventListener('change', updateType);
        document.getElementById('filterDate').addEventListener('change', () => { currentPage = 1; loadData(); });
        document.getElementById('btnPrev').addEventListener('click', () => { currentPage--; loadData(); });
        document.getElementById('btnNext').addEventListener('click', () => { currentPage++; loadData(); });
        loadData();
    });

    function updateType() {
        const t = document.getElementById('analyticsRange').value;
        const i = document.getElementById('filterDate');
        const n = new Date();
        if(t==='day') i.type='date'; else if(t==='month') i.type='month'; else i.type='number';
        currentPage = 1; loadData();
    }

    function loadData() {
        const t = document.getElementById('analyticsRange').value;
        const st = document.getElementById('tableStatusFilter').value;
        let d = document.getElementById('filterDate').value;
        if(t==='year') d += "-01-01";
        fetch(`/ThongKe/GetStatData?type=${t}&date=${d}&statusFilter=${st}&page=${currentPage}`)
            .then(r => r.json()).then(data => {
                renderStats(data.tongHop);
                renderChart(data.bieudo);
                renderTable(data.danhSachDonHang);
            });
    }

    function renderStats(s) {
        document.getElementById('valTotal').innerText = s.tongSoTiec;
        document.getElementById('valCancel').innerText = s.soTiecDaHuy;
        document.getElementById('valExpected').innerText = s.doanhThuDuKien;
        document.getElementById('valActual').innerText = s.thucThu;
        document.getElementById('valRemain').innerText = s.conLai;
    }

    function renderChart(d) {
        const c = document.getElementById('chartContainer');
        c.innerHTML = '';
        d.forEach(i => {
            const hC = i.totalCount > 0 ? (i.cancelCount/i.totalCount)*i.percentage : 0;
            c.innerHTML += `<div class="col-group"><div class="col-pair"><div class="bar-col bg-gold" data-v="${i.totalCount}" style="height:${i.percentage}%"></div><div class="bar-col bg-red" data-v="${i.cancelCount}" style="height:${hC}%"></div></div><div class="lbl-date">${i.label}</div></div>`;
        });
    }

    function renderTable(l) {
        const b = document.getElementById('tableBody');
        b.innerHTML = '';
        document.getElementById('pageInfo').innerText = `${l.currentPage}/${l.totalPages||1}`;
        document.getElementById('btnPrev').disabled = l.currentPage <= 1;
        document.getElementById('btnNext').disabled = l.currentPage >= l.totalPages;
        l.items.forEach(i => {
            let color = i.isCancelled ? 'var(--red)' : (i.trangThai==='Completed' ? 'var(--green)' : '#fff');
            let text = i.isCancelled ? 'Đã hủy' : (i.trangThai==='Completed' ? 'Hoàn tất' : 'Đã cọc 30%');
            b.insertAdjacentHTML('beforeend', `<tr><td style="color:#fff">${i.maDatTiec}</td><td>${i.ngayToChuc}</td><td>${i.khachHang}</td><td style="color:var(--gold)">${i.tongTien}</td><td style="color:${color}; font-weight:bold">${text}</td><td style="text-align:center"><button class="btn-xem" onclick="openPanel('${i.maDatTiec}')">Xem</button></td></tr>`);
        });
    }

    function openPanel(id) {
        document.getElementById('backdrop').classList.add('show');
        document.getElementById('sidePanel').classList.add('open');
        fetch(`/ThongKe/GetOrderDetail?id=${id}`).then(r => r.json()).then(d => {
            document.getElementById('p_Ma').innerText = d.maDatTiec;
            document.getElementById('p_Info').innerHTML = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><div><small style="color:#888">Khách hàng</small><br>${d.tenKhach}</div><div><small style="color:#888">Số điện thoại</small><br>${d.sdt}</div><div><small style="color:#888">Ngày / Giờ</small><br>${d.ngayToChuc} ${d.gioToChuc}</div><div><small style="color:#888">Số bàn</small><br>${d.soBan}</div></div><div style="margin-top:10px; color:${d.trangThai==='Đã hủy'?'var(--red)':'var(--gold)'}"><b>Trạng thái: ${d.trangThai}</b></div><div style="margin-top:5px; font-style:italic; font-size:12px;">Ghi chú: ${d.ghiChu}</div>`;
            let html = '<table style="width:100%; border-spacing:0 5px;">';
            d.monAn.forEach(m => html += `<tr><td>${m.tenMon}</td><td style="text-align:center">x${m.soLuong}</td><td style="text-align:right">${m.donGia}</td></tr>`);
            d.dichVu.forEach(v => html += `<tr><td>${v.tenDV}</td><td style="text-align:center">x${v.soLuong}</td><td style="text-align:right">${v.donGia}</td></tr>`);
            html += `<tr><td colspan="2" style="padding-top:15px;">Tổng cộng</td><td style="text-align:right; font-weight:bold; color:var(--gold); padding-top:15px;">${d.tongTien}</td></tr><tr><td colspan="2">Đã cọc</td><td style="text-align:right; color:var(--green);">${d.tienCoc}</td></tr></table>`;
            document.getElementById('p_Details').innerHTML = html;
        });
    }

    function closePanel() {
        document.getElementById('sidePanel').classList.remove('open');
        document.getElementById('backdrop').classList.remove('show');
    }
</script>